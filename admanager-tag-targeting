<?php
/**
 * Plugin Name:       Segmentação do Ad Manager por Taxonomias e Login
 * Plugin URI:        https://github.com/hzzq-xyz/Tag-Categorias-AdMananger
 * Description:       Envia automaticamente as tags, categorias e status de login do usuário para o Google Ad Manager como segmentação personalizada.
 * Version:           2.2
 * Author:            Gustavo Espindola Visentini
 * Author URI:        https://hzzq.xyz
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       admanager-taxonomy-targeting
 */

// Se este arquivo for chamado diretamente, aborte.
if ( ! defined( 'WPINC' ) ) {
	die;
}

/**
 * Função principal que injeta os scripts de segmentação no <head> do site.
 */
function admanager_custom_targeting_script() {

    $targeting_scripts = '';

    // --- NOVA LÓGICA PARA STATUS DE LOGIN ---
    // Esta verificação acontece em todas as páginas.
    // A função is_user_logged_in() é nativa do WordPress.
    if ( is_user_logged_in() ) {
        $login_status = 'logado';
    } else {
        $login_status = 'visitante';
    }
    // Adiciona a linha de segmentação para o status de login.
    $targeting_scripts .= "googletag.pubads().setTargeting('logado', '{$login_status}');\n";


    // --- LÓGICA PARA TAGS E CATEGORIAS ---
    // Esta verificação continua rodando apenas em páginas de posts.
    if ( is_single() ) {

        // Lógica para Tags
        $post_tags = get_the_tags();
        if ( $post_tags ) {
            $tags_array = array();
            foreach ( $post_tags as $tag ) {
                $tags_array[] = $tag->slug;
            }
            $js_tags_array = json_encode( $tags_array );
            $targeting_scripts .= "        googletag.pubads().setTargeting('tags', {$js_tags_array});\n";
        }

        // Lógica para Categorias
        $post_categories = get_the_category();
        if ( $post_categories ) {
            $cats_array = array();
            foreach ( $post_categories as $category ) {
                $cats_array[] = $category->slug;
            }
            $js_cats_array = json_encode( $cats_array );
            $targeting_scripts .= "        googletag.pubads().setTargeting('categorias', {$js_cats_array});";
        }
    }

    // Se houver algum script de segmentação para imprimir, continue.
    if ( ! empty( $targeting_scripts ) ) {
        echo <<<SCRIPT
<script>
    window.googletag = window.googletag || {cmd: []};
    googletag.cmd.push(function() {
        {$targeting_scripts}
    });
</script>
SCRIPT;
    }
}

// Renomeamos a função no add_action também
add_action( 'wp_head', 'admanager_custom_targeting_script' );
